group_by(ENSEMBL) %>%
summarize(
# conservar columnas numéricas (logFC, pvalue, etc.)
across(where(is.numeric), dplyr::first),
# conservar columnas no numéricas de all_results
Comparison = dplyr::first(Comparison),
cancer_type = dplyr::first(cancer_type),
# columnas de anotación
SYMBOL = unique(SYMBOL)[1],
GENENAME = unique(GENENAME)[1],
GO_terms = paste(unique(GO_terms[!is.na(GO_terms)]), collapse = "; "),
GO_ontology = paste(unique(GO_ontology[!is.na(GO_ontology)]), collapse = "; "),
Reactome_PATH = paste(unique(Reactome_PATH[!is.na(Reactome_PATH)]), collapse = "; "),
.groups = "drop"
) %>%
as.data.frame() %>%
rename(Gene = SYMBOL)
res_mer <- merge(res, annot_final, by = "ENSEMBL", all.x = TRUE)
# Ahora condensar columnas de anotación sin perder las de res
res_mer_unique <- res_mer %>%
group_by(ENSEMBL) %>%
summarize(
# conservar columnas numéricas (logFC, pvalue, etc.)
across(where(is.numeric), dplyr::first),
# conservar columnas no numéricas de all_results
Comparison = dplyr::first(Comparison),
cancer_type = dplyr::first(cancer_type),
# columnas de anotación
SYMBOL = unique(SYMBOL)[1],
GENENAME = unique(GENENAME)[1],
GO_terms = paste(unique(GO_terms[!is.na(GO_terms)]), collapse = "; "),
GO_ontology = paste(unique(GO_ontology[!is.na(GO_ontology)]), collapse = "; "),
Reactome_PATH = paste(unique(Reactome_PATH[!is.na(Reactome_PATH)]), collapse = "; "),
.groups = "drop"
) %>%
as.data.frame()
# Verificar
head(res_mer_unique)
View(res_mer_unique)
View(res_mer_unique)
res$expr_Met_Bone_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Bone", drop = FALSE], 1, sd, na.rm = TRUE)
annot_final_unique <- annot_final %>%
group_by(ENSEMBL) %>%
summarize(
SYMBOL = unique(SYMBOL)[1],
GENENAME = unique(GENENAME)[1],
GO_terms = paste(unique(GO_terms[!is.na(GO_terms)]), collapse = "; "),
GO_ontology = paste(unique(GO_ontology[!is.na(GO_ontology)]), collapse = "; "),
Reactome_PATH = paste(unique(Reactome_PATH[!is.na(Reactome_PATH)]), collapse = "; "),
.groups = "drop"
)
# Ahora hacer el merge SIN duplicar filas
res_mer <- res %>% left_join(annot_final_unique, by = "ENSEMBL")
# Verificar
head(res_mer)
View(res_mer)
colnames(res_mer_unique)[colnames(res_mer_unique) == "SYMBOL"] <- "Gene"
colnames(res_mer_unique)[colnames(res_mer_unique) == "Genename"] <- "GENENAME"
colnames(res_mer)[colnames(res_mer) == "Genename"] <- "GENENAME"
colnames(res_mer)[colnames(res_mer) == "SYMBOL"] <- "Gene"
colnames(res_mer)[colnames(res_mer) == "Genename"] <- "GENENAME"
saveRDS(res_mer, file = "data_metastasis_melanoma.rds")
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
data_Melanoma <- readRDS("~/Gene_Searcher/data_Melanoma.rds")
runApp()
runApp()
shiny::runApp()
knitr::opts_chunk$set(echo = TRUE)
rna <- read.delim("./mel_dfci_2019/data_mrna_seq_tpm.txt", comment.char = "#", stringsAsFactors = FALSE)
clinical <- read.delim("./mel_dfci_2019/mel_dfci_2019/data_clinical_patient.txt", comment.char = "#", stringsAsFactors = FALSE)
samples  <- read.delim("./mel_dfci_2019/mel_dfci_2019/data_clinical_sample.txt", comment.char = "#", stringsAsFactors = FALSE)
library(AnnotationDbi)
library(biomaRt)
library(DESeq2)
library(dplyr)
library(EnhancedVolcano)
library(KEGGREST)
library(limma)
library(org.Hs.eg.db)
library(reactome.db)
library(stringr)
library(SummarizedExperiment)
library(tibble)
library(TCGAbiolinks)
library(UCSCXenaTools)
# Conectar con la base de datos de genes humanos en Ensembl
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
# Obtener tabla de conversión
gene_map <- getBM(
attributes = c("ensembl_gene_id", "hgnc_symbol"),
mart = ensembl
)
df_annot <- rna %>%
left_join(gene_map, by = c("Hugo_Symbol" = "hgnc_symbol"))
df_annot <- df_annot %>%
dplyr::select(1, ensembl_gene_id, everything())
df_annot$Hugo_Symbol <- NULL
df_annot$Entrez_Gene_Id <- NULL
df_annot
samples$sample_group <- case_when(
samples$BIOPSY_SITE_CATEG %in% c("skin") ~ "Met_Skin",
samples$BIOPSY_SITE_CATEG == "brain" ~ "Met_Brain",
samples$BIOPSY_SITE_CATEG == "lymph node" ~ "Met_Lymph",
samples$BIOPSY_SITE_CATEG == "liver/visceral" ~ "Met_Liver",
samples$BIOPSY_SITE_CATEG == "soft tissue" ~ "Met_Tissue",
samples$BIOPSY_SITE_CATEG == "lung" ~ "Met_Lung",
samples$BIOPSY_SITE_CATEG == "bone" ~ "Met_Bone",
TRUE ~ NA_character_
)
# Filtrar NA
samples <- samples %>%
filter(!is.na(sample_group))
df_annot_unique <- df_annot %>%
dplyr::filter(!is.na(ensembl_gene_id)) %>%
group_by(ensembl_gene_id) %>%
summarize(across(where(is.numeric), sum), .groups = "drop")
# Convertir a matrix con rownames
df_matrix <- as.matrix(df_annot_unique[, -1])
rownames(df_matrix) <- df_annot_unique$ensembl_gene_id
# Filtrar solo las columnas de las muestras
common_samples <- intersect(colnames(df_matrix), samples$SAMPLE_ID)
df_matrix <- df_matrix[, common_samples, drop = FALSE]
# Comprobar resultado
table(samples$sample_group)
df_met <- log2(df_matrix + 1)
data(XenaData)
# Buscar datasets asociados al melanoma (TCGA-SKCM)
xena_datasets <- XenaData %>%
dplyr::filter(grepl("TCGA-SKCM", XenaDatasets)) %>%
dplyr::select(XenaDatasets, XenaCohorts, DataSubtype, Type, XenaHostNames)
xena_datasets
url <- "https://xenabrowser.net/datapages/"
try(httr::GET(url))
data(XenaData)
options(timeout = 600)
# Elegir TPM
dataset_expr <- "TCGA-SKCM.star_tpm.tsv"
dataset_clin <- "TCGA-SKCM.GDC_phenotype.tsv"
# Descargar
expr_obj <- XenaGenerate(subset = XenaDatasets == dataset_expr) %>%
XenaQuery() %>%
XenaDownload()
clin_obj <- XenaGenerate(subset = XenaDatasets == dataset_clin) %>%
XenaQuery() %>%
XenaDownload()
# Preparar datos
expr <- XenaPrepare(expr_obj)
clin <- XenaPrepare(clin_obj)
expr_mat <- as.data.frame(expr)
clin_df <- as.data.frame(clin)
head(colnames(expr_mat))
head(clin_df$submitter_id.samples)
expr_ids <- substr(colnames(expr_mat), 1, 15)
clin_ids <- substr(clin_df$submitter_id.samples, 1, 15)
common_samples <- intersect(expr_ids, clin_ids)
length(common_samples)
head(common_samples)
# Establecer los IDs recortados como definitivos
colnames(expr_mat) <- substr(colnames(expr_mat), 1, 15)
clin_df$submitter_id.samples <- substr(clin_df$submitter_id.samples, 1, 15)
# Filtrar y alinear según las muestras comunes
expr_mat <- expr_mat[, c("Ensembl_ID", common_samples)]
rownames(expr_mat) <- expr_mat$Ensembl_ID
expr_mat$Ensembl_ID <- NULL
clin_df <- clin_df[match(common_samples, clin_df$submitter_id.samples), ]
# Comprobar
dim(expr_mat)
dim(clin_df)
all(colnames(expr_mat) == clin_df$submitter_id.samples)
clin_df$sample_group <- case_when(
clin_df$sample_type.samples %in% c("Metastatic") ~ "Metastatic",
clin_df$sample_type.samples == "Primary Tumor" ~ "Primary.Tumor",
clin_df$sample_type.samples == "Solid Tissue Normal" ~ "Solid.Tissue.Normal",
TRUE ~ NA_character_
)
# Eliminar NA
clin_df <- clin_df %>%
filter(sample_group == "Primary.Tumor")
#Sincronizar expresión y metadata
expr_mat <- expr_mat[, clin_df$submitter_id.sample, drop = FALSE]
# Comprobar resultado
table(clin_df$sample_group)
rownames(expr_mat) <- sub("\\.[0-9]+$", "", rownames(expr_mat))
genes1 <- rownames(df_log2)
genes1 <- rownames(df_met)
genes2 <- rownames(expr_mat)
genes_comunes <- intersect(genes1, genes2)
length(genes_comunes)
expr1_common <- df_met[genes_comunes,, drop = FALSE]
expr2_common <- expr_mat[genes_comunes, , drop = FALSE]
expr_merged <- cbind(expr1_common, expr2_common)
expr_merged
meta1_sub <- samples %>% dplyr::select(SAMPLE_ID, sample_group)
meta2_sub <- clin_df %>% dplyr::select(submitter_id.samples, sample_group)
colnames(meta2_sub) <- make.names(colnames(meta2_sub))
meta2_sub <- meta2_sub %>% dplyr::rename(SAMPLE_ID = submitter_id.samples)
metadata_combined <- bind_rows(meta1_sub, meta2_sub)
metadata_combined <- metadata_combined %>%
dplyr::filter(SAMPLE_ID %in% colnames(expr_mat_merged))
View(metadata_combined)
View(expr_merged)
colnames(meta2_sub) <- make.names(colnames(meta2_sub))
meta2_sub <- meta2_sub %>% dplyr::rename(SAMPLE_ID = submitter_id.samples)
metadata_combined <- metadata_combined %>%
dplyr::filter(SAMPLE_ID %in% colnames(expr_mat_merged))
library(dplyr)
metadata_combined <- metadata_combined %>%
dplyr::filter(SAMPLE_ID %in% colnames(expr_mat_merged))
metadata_combined <- metadata_combined %>%
filter(SAMPLE_ID %in% colnames(expr_mat_merged))
metadata_combined <- metadata_combined %>%
filter(SAMPLE_ID %in% colnames(expr_merged))
unique(metadata_filtered$sample_group)
metadata_filtered <- metadata_combined %>%
filter(SAMPLE_ID %in% colnames(expr_merged))
unique(metadata_filtered$sample_group)
group <- factor(
metadata_filtered$sample_group,
levels = c("Met_Skin","Met_Brain","Met_Liver","Met_Lymph","Met_Tissue","Met_Lung","Met_Bone","Primary.Tumor")
)
design <- model.matrix(~0 + group)
colnames(design) <- levels(group)
contrast_matrix <- makeContrasts(
Met_Skin_vs_Met_Brain  = Met_Skin - Met_Brain,
Met_Skin_vs_Met_Liver  = Met_Skin - Met_Liver,
Met_Skin_vs_Met_Lymph  = Met_Skin - Met_Lymph,
Met_Skin_vs_Met_Tissue = Met_Skin - Met_Tissue,
Met_Skin_vs_Met_Lung   = Met_Skin - Met_Lung,
Met_Brain_vs_Met_Liver  = Met_Brain - Met_Liver,
Met_Brain_vs_Met_Lymph  = Met_Brain - Met_Lymph,
Met_Brain_vs_Met_Tissue = Met_Brain - Met_Tissue,
Met_Brain_vs_Met_Lung   = Met_Brain - Met_Lung,
Met_Liver_vs_Met_Lymph  = Met_Liver - Met_Lymph,
Met_Liver_vs_Met_Tissue = Met_Liver - Met_Tissue,
Met_Liver_vs_Met_Lung   = Met_Liver - Met_Lung,
Met_Lymph_vs_Met_Tissue = Met_Lymph - Met_Tissue,
Met_Lymph_vs_Met_Lung   = Met_Lymph - Met_Lung,
Met_Tissue_vs_Met_Lung  = Met_Tissue - Met_Lung,
levels = design
)
# Ajuste del modelo
fit <- lmFit(expr_mat_merged, design)
contrast_matrix <- makeContrasts(
Met_Skin_vs_Met_Brain  = Met_Skin - Met_Brain,
Met_Skin_vs_Met_Liver  = Met_Skin - Met_Liver,
Met_Skin_vs_Met_Lymph  = Met_Skin - Met_Lymph,
Met_Skin_vs_Met_Tissue = Met_Skin - Met_Tissue,
Met_Skin_vs_Met_Lung   = Met_Skin - Met_Lung,
Met_Brain_vs_Met_Liver  = Met_Brain - Met_Liver,
Met_Brain_vs_Met_Lymph  = Met_Brain - Met_Lymph,
Met_Brain_vs_Met_Tissue = Met_Brain - Met_Tissue,
Met_Brain_vs_Met_Lung   = Met_Brain - Met_Lung,
Met_Liver_vs_Met_Lymph  = Met_Liver - Met_Lymph,
Met_Liver_vs_Met_Tissue = Met_Liver - Met_Tissue,
Met_Liver_vs_Met_Lung   = Met_Liver - Met_Lung,
Met_Lymph_vs_Met_Tissue = Met_Lymph - Met_Tissue,
Met_Lymph_vs_Met_Lung   = Met_Lymph - Met_Lung,
Met_Tissue_vs_Met_Lung  = Met_Tissue - Met_Lung,
levels = design
)
# Ajuste del modelo
fit <- lmFit(expr_merged, design)
fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2)
library(dplyr)
# Lista de todos los contrastes entre metástasis (sin Met_Bone)
contrast_names <- c(
"Met_Skin_vs_Met_Brain",
"Met_Skin_vs_Met_Liver",
"Met_Skin_vs_Met_Lymph",
"Met_Skin_vs_Met_Tissue",
"Met_Skin_vs_Met_Lung",
"Met_Brain_vs_Met_Liver",
"Met_Brain_vs_Met_Lymph",
"Met_Brain_vs_Met_Tissue",
"Met_Brain_vs_Met_Lung",
"Met_Liver_vs_Met_Lymph",
"Met_Liver_vs_Met_Tissue",
"Met_Liver_vs_Met_Lung",
"Met_Lymph_vs_Met_Tissue",
"Met_Lymph_vs_Met_Lung",
"Met_Tissue_vs_Met_Lung"
)
# Generar resultados filtrados automáticamente en una lista
res_list_filtered <- lapply(contrast_names, function(coef_name) {
topTable(fit2, coef = coef_name, number = Inf) %>%
mutate(Comparison = coef_name) %>%
filter(abs(logFC) >= 1, adj.P.Val < 0.05)  # filtrado
})
# Unir todos los resultados filtrados en un solo data frame
res_all_filtered <- bind_rows(res_list_filtered)
library(dplyr)
# Lista de todos los contrastes entre metástasis (sin Met_Bone)
contrast_names <- c(
"Met_Skin_vs_Met_Brain",
"Met_Skin_vs_Met_Liver",
"Met_Skin_vs_Met_Lymph",
"Met_Skin_vs_Met_Tissue",
"Met_Skin_vs_Met_Lung",
"Met_Brain_vs_Met_Liver",
"Met_Brain_vs_Met_Lymph",
"Met_Brain_vs_Met_Tissue",
"Met_Brain_vs_Met_Lung",
"Met_Liver_vs_Met_Lymph",
"Met_Liver_vs_Met_Tissue",
"Met_Liver_vs_Met_Lung",
"Met_Lymph_vs_Met_Tissue",
"Met_Lymph_vs_Met_Lung",
"Met_Tissue_vs_Met_Lung"
)
# Generar resultados filtrados automáticamente en una lista
res_list_filtered <- lapply(contrast_names, function(coef_name) {
topTable(fit2, coef = coef_name, number = Inf) %>%
mutate(Comparison = coef_name) %>%
filter(abs(logFC) >= 1, adj.P.Val < 0.05)  # filtrado
})
# Unir todos los resultados filtrados en un solo data frame
res <- bind_rows(res_list_filtered)
# Filtra y reordena según res$ENSEMBL, respetando duplicados
expr_subset <- expr_mat_merged[rownames(expr_merged) %in% res$ENSEMBL, , drop = FALSE]
# Filtra y reordena según res$ENSEMBL, respetando duplicados
expr_subset <- expr_merged[rownames(expr_merged) %in% res$ENSEMBL, , drop = FALSE]
expr_subset <- expr_subset[match(res$ENSEMBL, rownames(expr_subset)), , drop = FALSE]
# Añade la columna ENSEMBL para mantener el identificador
expr_subset <- cbind(ENSEMBL = res$ENSEMBL, expr_subset)
# Comprobación segura: todas las filas están presentes
all(expr_subset$ENSEMBL %in% rownames(expr_merged))
expr_subset$ENSEMBL <- NULL
# Ahora calcula las medias por grupo, solo para esos genes
res$expr_Tumor_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Primary.Tumor", drop = FALSE], na.rm = TRUE)
View(expr_subset)
View(res)
# Filtra y reordena según res$ENSEMBL, respetando duplicados
expr_subset <- expr_merged[rownames(expr_merged) %in% rownames(res), , drop = FALSE]
expr_subset <- expr_subset[match(rownames(res), rownames(expr_subset)), , drop = FALSE]
# Añade la columna ENSEMBL para mantener el identificador
expr_subset <- cbind(ENSEMBL = rownames(res), expr_subset)
# Comprobación segura: todas las filas están presentes
all(rownames(res) %in% rownames(expr_merged))
# Filtra y reordena según res$ENSEMBL, respetando duplicados
expr_subset <- expr_merged[rownames(expr_merged) %in% rownames(res), , drop = FALSE]
expr_subset <- expr_subset[match(rownames(res), rownames(expr_subset)), , drop = FALSE]
# Añade la columna ENSEMBL para mantener el identificador
expr_subset <- cbind(ENSEMBL = rownames(res), expr_subset)
# Comprobación segura: todas las filas están presentes
all(expr_subset$ENSEMBL %in% rownames(expr_merged))
View(expr_subset)
View(expr_merged)
library(dplyr)
# Lista de todos los contrastes entre metástasis (sin Met_Bone)
contrast_names <- c(
"Met_Skin_vs_Met_Brain",
"Met_Skin_vs_Met_Liver",
"Met_Skin_vs_Met_Lymph",
"Met_Skin_vs_Met_Tissue",
"Met_Skin_vs_Met_Lung",
"Met_Brain_vs_Met_Liver",
"Met_Brain_vs_Met_Lymph",
"Met_Brain_vs_Met_Tissue",
"Met_Brain_vs_Met_Lung",
"Met_Liver_vs_Met_Lymph",
"Met_Liver_vs_Met_Tissue",
"Met_Liver_vs_Met_Lung",
"Met_Lymph_vs_Met_Tissue",
"Met_Lymph_vs_Met_Lung",
"Met_Tissue_vs_Met_Lung"
)
# Generar resultados filtrados automáticamente en una lista
res_list_filtered <- lapply(contrast_names, function(coef_name) {
topTable(fit2, coef = coef_name, number = Inf) %>%
rownames_to_column(var = "ENSEMBL") %>%   # Convertir rownames a columna
mutate(Comparison = coef_name) %>%
filter(abs(logFC) >= 1, adj.P.Val < 0.05) # filtrado
})
# Unir todos los resultados filtrados en un solo data frame
res <- bind_rows(res_list_filtered)
# Filtra y reordena según res$ENSEMBL, respetando duplicados
expr_subset <- expr_merged[rownames(expr_merged) %in% res$ENSEMBL, , drop = FALSE]
expr_subset <- expr_subset[match(res$ENSEMBL, rownames(expr_subset)), , drop = FALSE]
# Añade la columna ENSEMBL para mantener el identificador
expr_subset <- cbind(ENSEMBL = res$ENSEMBL, expr_subset)
# Comprobación segura: todas las filas están presentes
all(expr_subset$ENSEMBL %in% rownames(expr_merged))
View(expr_subset)
expr_subset$ENSEMBL <- NULL
# Ahora calcula las medias por grupo, solo para esos genes
res$expr_Tumor_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Primary.Tumor", drop = FALSE], na.rm = TRUE)
res$expr_Met_Skin_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Skin", drop = FALSE], na.rm = TRUE)
res$expr_Met_Brain_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Brain", drop = FALSE], na.rm = TRUE)
res$expr_Met_Liver_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Liver", drop = FALSE], na.rm = TRUE)
res$expr_Met_Lymph_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Lymph", drop = FALSE], na.rm = TRUE)
res$expr_Met_Tissue_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Tissue", drop = FALSE], na.rm = TRUE)
res$expr_Met_Lung_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Lung", drop = FALSE], na.rm = TRUE)
res$expr_Met_Bone_mean <- rowMeans(expr_subset[, metadata_filtered$sample_group == "Met_Bone", drop = FALSE], na.rm = TRUE)
res$expr_Tumor_median <- apply(expr_subset[, metadata_filtered$sample_group == "Primary.Tumor", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Skin_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Skin", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Brain_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Brain", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Liver_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Liver", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Tissue_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Tissue", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Lymph_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Lymph", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Lung_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Lung", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Met_Bone_median <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Bone", drop = FALSE], 1, median, na.rm = TRUE)
res$expr_Tumor_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Primary.Tumor", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Skin_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Skin", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Brain_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Brain", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Liver_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Liver", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Tissue_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Tissue", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Lymph_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Lymph", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Lung_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Lung", drop = FALSE], 1, sd, na.rm = TRUE)
res$expr_Met_Bone_sd <- apply(expr_subset[, metadata_filtered$sample_group == "Met_Bone", drop = FALSE], 1, sd, na.rm = TRUE)
colnames(res)
annotations <- AnnotationDbi::select(org.Hs.eg.db,
keys = res$ENSEMBL,
keytype = "ENSEMBL", #modificar si se está trabajando con otro tipo de keytype
columns = c("SYMBOL", "GENENAME", "PATH"))
annotations
annotations <- AnnotationDbi::select(org.Hs.eg.db,
keys = res$ENSEMBL,
keytype = "ENSEMBL", #modificar si se está trabajando con otro tipo de keytype
columns = c("SYMBOL", "GENENAME", "PATH"))
reactome_ann_genes <- AnnotationDbi::select( org.Hs.eg.db,
keys =  res$ENSEMBL,
keytype =  "ENSEMBL",
columns = c("ENTREZID")
)
# GO annotation
go_ann <- AnnotationDbi::select(org.Hs.eg.db,
keys = res$ENSEMBL,
keytype = "ENSEMBL",
columns = c("GO", "ONTOLOGY"))
# Reactome
reactome_ann <- AnnotationDbi::select(reactome.db,
keys = reactome_ann_genes$ENTREZID,
keytype = "ENTREZID",
columns = c("PATHNAME"))
# Unir SYMBOL + GENENAME
annot_base <- annotations %>%
dplyr::select(ENSEMBL, SYMBOL, GENENAME) %>%
dplyr::distinct()
# Añadir GO
annot_go <- go_ann %>%
group_by(ENSEMBL) %>%
summarize(
GO_terms = paste(unique(GO), collapse = "; "),
GO_ontology = paste(unique(ONTOLOGY), collapse = "; "),
.groups = "drop"
)
annot_base <- annot_base %>%
left_join(annot_go, by = "ENSEMBL")
# Añadir Reactome
annot_reactome <- reactome_ann %>%
group_by(ENTREZID) %>%
summarize(
Reactome_PATH = paste(unique(PATHNAME), collapse = "; "),
.groups = "drop"
)
# Unimos mediante ENTREZID → ENSEMBL
reactome_full <- reactome_ann_genes %>%
dplyr::select(ENSEMBL, ENTREZID) %>%
dplyr::distinct() %>%
left_join(annot_reactome, by = "ENTREZID") %>%
dplyr::select(-ENTREZID)
# Juntar todo en una tabla final
annot_final <- annot_base %>%
left_join(reactome_full, by = "ENSEMBL")
# Vista previa
head(annot_final)
annot_final_unique <- annot_final %>%
group_by(ENSEMBL) %>%
summarize(
SYMBOL = unique(SYMBOL)[1],
GENENAME = unique(GENENAME)[1],
GO_terms = paste(unique(GO_terms[!is.na(GO_terms)]), collapse = "; "),
GO_ontology = paste(unique(GO_ontology[!is.na(GO_ontology)]), collapse = "; "),
Reactome_PATH = paste(unique(Reactome_PATH[!is.na(Reactome_PATH)]), collapse = "; "),
.groups = "drop"
)
# Ahora hacer el merge SIN duplicar filas
res_mer <- res %>% left_join(annot_final_unique, by = "ENSEMBL")
# Verificar
head(res_mer)
colnames(res_mer)[colnames(res_mer) == "SYMBOL"] <- "Gene"
colnames(res_mer)[colnames(res_mer) == "Genename"] <- "GENENAME"
View(res_mer)
saveRDS(res_mer, file = "data_Metastasis_vs_Metastasis_Melanoma.rds")
saveRDS(res_mer, file = "./Gene_Searcher/data_Metastasis_vs_Metastasis_Melanoma.rds")
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
